import{r as a,j as e}from"./vendor-Coh6w-wA.js";import{t as L,s as N,c}from"./index-CFnRQUVA.js";import{O as G,R as F,y as M}from"./icons-BlIjFQrJ.js";import"./radix-wrHiDKbY.js";import"./tanstack-x3w5gpW7.js";import"./supabase-jRWW_51U.js";import"./router-jL34xOpu.js";function q(y,w){const n=new Date(y).getTime(),h=new Date(w).getTime();return Math.max(0,h-n)/(1e3*60*60*24)}const V=()=>{const[y,w]=a.useState([]),[n,h]=a.useState(""),[u,k]=a.useState(()=>{const t=new Date;return t.setDate(t.getDate()-30),t.toISOString().slice(0,10)}),[b,$]=a.useState(()=>L()),[S,D]=a.useState(!1),[j,C]=a.useState(null),[m,T]=a.useState(null),[l,A]=a.useState([]),[I,P]=a.useState([]),[O,R]=a.useState(null);a.useEffect(()=>{(async()=>{var t;try{const{data:d,error:s}=await N.from("projects").select("*").order("created_at",{ascending:!1});if(s)throw s;w(d||[]),!n&&((t=d==null?void 0:d[0])!=null&&t.id)&&h(d[0].id)}catch(d){console.error(d)}})()},[]);const E=async()=>{if(n){D(!0),R(null);try{const{data:t,error:d}=await N.from("projects").select("*").eq("id",n).single();if(d)throw d;T(t);const s=new Date(u+"T00:00:00").toISOString(),x=new Date(b+"T23:59:59").toISOString(),{data:p,error:f}=await N.from("action_items").select("*").eq("project_id",n).is("deleted_at",null).or(`and(created_at.gte.${s},created_at.lte.${x}),
           and(completed_at.gte.${s},completed_at.lte.${x}),
           and(cancelled_at.gte.${s},cancelled_at.lte.${x})`).order("created_at",{ascending:!0});if(f)throw f;A(p||[]);const{data:_,error:v}=await N.from("daily_logs").select("*, project:projects(*)").eq("project_id",n).gte("date",u).lte("date",b).order("date",{ascending:!0});if(v)throw v;P(_||[]),C(new Date().toISOString())}catch(t){R((t==null?void 0:t.message)||"Generate failed"),T(null),A([]),P([]),C(null)}finally{D(!1)}}},o=a.useMemo(()=>{const t=new Date().toISOString(),d=l.filter(r=>r.status==="open"||r.status==="in_progress"||r.status==="blocked"),s=l.filter(r=>r.status==="done"),x=l.filter(r=>r.status==="cancelled"),p=d.filter(r=>r.due_date&&new Date(r.due_date).getTime()<Date.now()).length,f=s.filter(r=>r.due_date&&r.completed_at&&new Date(r.due_date).getTime()<new Date(r.completed_at).getTime()).length,_=(()=>{const r=s.filter(i=>i.completed_at).map(i=>q(i.created_at,i.completed_at));return r.length===0?0:r.reduce((i,g)=>i+g,0)/r.length})(),v=(()=>{const r=l.filter(g=>(g.priority||"").toLowerCase()==="high");if(r.length===0)return 0;const i=r.filter(g=>g.status==="done").length;return Math.round(i/r.length*100)})();return{total:l.length,operational:d.length,done:s.length,cancelled:x.length,overdueNow:p,doneOverdue:f,avgCompletionDays:Math.round(_*10)/10,highDoneRate:v,generatedAt:j||t}},[l,j]);return e.jsxs("div",{className:"space-y-6 print:bg-white print:text-black print:p-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Job Audit Report"}),e.jsx("button",{onClick:()=>window.print(),className:"px-4 py-2 rounded-xl bg-primary text-primary-foreground text-sm font-semibold hover:opacity-90 transition print:hidden",children:"Print Report"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Printable, defensible record of actions and logs for a selected job."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>window.print(),className:"flex items-center gap-2 px-3 py-2 rounded-xl bg-card border border-border hover:bg-muted transition-colors text-sm",title:"Print / Save as PDF",children:[e.jsx(G,{className:"w-4 h-4"}),"Print"]}),e.jsxs("button",{onClick:E,disabled:S||!n,className:"flex items-center gap-2 px-3 py-2 rounded-xl bg-primary text-primary-foreground hover:opacity-90 transition text-sm font-semibold disabled:opacity-60",children:[S?e.jsx(F,{className:"w-4 h-4 animate-spin"}):e.jsx(M,{className:"w-4 h-4"}),"Generate"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-3 print:hidden",children:[e.jsxs("div",{className:"lg:col-span-2 bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-2",children:"Project"}),e.jsx("select",{value:n,onChange:t=>h(t.target.value),className:"w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm text-foreground",children:y.map(t=>e.jsxs("option",{value:t.id,children:[t.job_number?`${t.job_number} — `:"",t.name]},t.id))})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-2",children:"From"}),e.jsx("input",{type:"date",value:u,onChange:t=>k(t.target.value),className:"w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm text-foreground"})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-2",children:"To"}),e.jsx("input",{type:"date",value:b,onChange:t=>$(t.target.value),className:"w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm text-foreground"})]})]}),O&&e.jsx("div",{className:"bg-danger/10 border border-danger/20 text-danger rounded-xl p-3 text-sm",children:O}),j&&m&&e.jsxs("div",{className:"space-y-6 print:bg-white print:text-black print:p-0",children:[e.jsxs("div",{className:"bg-card border border-border rounded-xl p-4 print:border-0 print:bg-white print:p-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-bold text-foreground",children:[m.job_number?`${m.job_number} — `:"",m.name]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:m.location||m.client||"—"})]}),e.jsxs("div",{className:"text-right text-xs text-muted-foreground",children:[e.jsxs("div",{children:["Range: ",c(u)," → ",c(b)]}),e.jsxs("div",{children:["Generated: ",c(o.generatedAt)]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 mt-4",children:[e.jsxs("div",{className:"bg-muted/40 border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Total items"}),e.jsx("div",{className:"text-lg font-bold text-foreground",children:o.total})]}),e.jsxs("div",{className:"bg-muted/40 border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Open / Active"}),e.jsx("div",{className:"text-lg font-bold text-foreground",children:o.operational})]}),e.jsxs("div",{className:"bg-muted/40 border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Done"}),e.jsx("div",{className:"text-lg font-bold text-foreground",children:o.done})]}),e.jsxs("div",{className:"bg-muted/40 border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Cancelled"}),e.jsx("div",{className:"text-lg font-bold text-foreground",children:o.cancelled})]})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl overflow-hidden print:border-0 print:bg-white",children:[e.jsxs("div",{className:"px-4 py-3 border-b border-border print:border-0",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:"Action Items (Full Lifecycle)"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-0.5",children:"Chronological by created date. Soft-deleted excluded."})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-xs print:text-[11px]",children:[e.jsx("thead",{className:"bg-muted/40",children:e.jsxs("tr",{className:"text-left text-muted-foreground",children:[e.jsx("th",{className:"px-3 py-2",children:"Created"}),e.jsx("th",{className:"px-3 py-2",children:"Status"}),e.jsx("th",{className:"px-3 py-2",children:"Priority"}),e.jsx("th",{className:"px-3 py-2",children:"Title"}),e.jsx("th",{className:"px-3 py-2",children:"Due"}),e.jsx("th",{className:"px-3 py-2",children:"Completed/Cancelled"}),e.jsx("th",{className:"px-3 py-2",children:"Overdue?"})]})}),e.jsxs("tbody",{children:[l.map(t=>{const d=t.status==="done"?t.completed_at:t.status==="cancelled"?t.cancelled_at:null,s=(()=>{if(!t.due_date)return"—";const x=new Date(t.due_date).getTime(),p=d?new Date(d).getTime():Date.now();return x<p?"YES":"no"})();return e.jsxs("tr",{className:"border-t border-border/60 print:break-inside-avoid",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:c(t.created_at)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:t.status}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:t.priority||"—"}),e.jsxs("td",{className:"px-3 py-2 min-w-[260px]",children:[e.jsx("div",{className:"text-foreground font-medium",children:t.title||"Unnamed"}),t.details&&e.jsx("div",{className:"text-muted-foreground truncate max-w-[520px]",children:t.details})]}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:t.due_date?c(t.due_date):"—"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:d?c(d):"—"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:s})]},t.id)}),l.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-6 text-muted-foreground",colSpan:7,children:"No action items in range."})})]})]})})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl overflow-hidden print:border-0 print:bg-white",children:[e.jsxs("div",{className:"px-4 py-3 border-b border-border print:border-0",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:"Daily Logs Summary"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-0.5",children:"Chronological by date."})]}),e.jsxs("div",{className:"divide-y divide-border",children:[I.map(t=>e.jsxs("div",{className:"px-4 py-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:c(t.date)}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-0.5",children:[t.weather||"—"," ",t.temperature?`• ${t.temperature}`:""]})]}),e.jsx("div",{className:"text-xs text-muted-foreground text-right",children:t.safety_incidents?e.jsxs("div",{children:["Safety incidents: ",String(t.safety_incidents)]}):e.jsx("div",{children:"Safety incidents: 0"})})]}),t.critical_items&&e.jsxs("div",{className:"mt-2 p-2 rounded-lg bg-danger/10 border border-danger/20",children:[e.jsx("div",{className:"text-xs font-semibold text-danger",children:"Critical"}),e.jsx("div",{className:"text-xs text-danger",children:t.critical_items})]})]},t.id)),I.length===0&&e.jsx("div",{className:"px-4 py-6 text-sm text-muted-foreground",children:"No daily logs in range."})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-4 print:border-0 print:bg-white",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:"Overdue Analysis"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 mt-3",children:[e.jsxs("div",{className:"bg-muted/40 border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Currently overdue"}),e.jsx("div",{className:"text-lg font-bold text-foreground",children:o.overdueNow})]}),e.jsxs("div",{className:"mt-8 pt-4 border-t border-border text-[11px] text-muted-foreground print:text-black",children:[e.jsxs("div",{children:["Generated: ",c(o.generatedAt)]}),e.jsx("div",{children:"System: Long Line Diary"}),e.jsx("div",{children:"Document type: Job Audit Report"})]}),e.jsxs("div",{className:"bg-muted/40 border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Done overdue"}),e.jsx("div",{className:"text-lg font-bold text-foreground",children:o.doneOverdue})]}),e.jsxs("div",{className:"bg-muted/40 border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Avg completion (days)"}),e.jsx("div",{className:"text-lg font-bold text-foreground",children:o.avgCompletionDays})]}),e.jsxs("div",{className:"bg-muted/40 border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"High priority done rate"}),e.jsxs("div",{className:"text-lg font-bold text-foreground",children:[o.highDoneRate,"%"]})]})]})]})]}),!j&&e.jsxs("div",{className:"bg-card border border-border rounded-xl p-8 text-center text-sm text-muted-foreground",children:["Select a project and date range, then click ",e.jsx("span",{className:"text-foreground font-semibold",children:"Generate"}),"."]})]})};export{V as default};
