import{r as n,j as e}from"./vendor-Coh6w-wA.js";import{f as le,a as ie,t as j,b as ce,s as C,c as F,r as me}from"./index-Cgf2erep.js";import{P as q}from"./PriorityBadge-CZTRhtYn.js";import{A as ue}from"./ActionItemDetailModal-CgIKUaRV.js";import{P as xe,B as pe,C as be,b as M,t as U,u as ge,v as he,W as fe,w as ye,k as je,T as ve,x as Ne,H as we}from"./icons-DuXLjBGX.js";import"./radix-wrHiDKbY.js";import"./tanstack-x3w5gpW7.js";import"./supabase-jRWW_51U.js";import"./router-jL34xOpu.js";const _e=[{key:"overdue",title:"Overdue",pillClass:"bg-danger/15 text-danger border border-danger/30",cardLeftBorderClass:"border-l-4 border-l-danger/70"},{key:"due_today",title:"Due Today",pillClass:"bg-primary/15 text-primary border border-primary/30",cardLeftBorderClass:"border-l-4 border-l-primary/70"},{key:"upcoming",title:"Upcoming",pillClass:"bg-muted text-foreground border border-primary/40",cardLeftBorderClass:"border-l-4 border-l-border"},{key:"no_due_date",title:"No Due Date",pillClass:"bg-muted/60 text-muted-foreground border border-primary/40",cardLeftBorderClass:"border-l-4 border-l-muted"}];function V(o){const l=o.getFullYear(),x=String(o.getMonth()+1).padStart(2,"0"),p=String(o.getDate()).padStart(2,"0");return`${l}-${x}-${p}`}function Ce(o){if(!o)return"no_due_date";const l=new Date(o);if(Number.isNaN(l.getTime()))return"no_due_date";const p=V(new Date),c=V(l);return c<p?"overdue":c===p?"due_today":"upcoming"}function H(o){if(!o)return 3;const l=String(o).toLowerCase();return l==="critical"?0:l==="high"?1:l==="medium"?2:3}const Ae=({onNavigate:o,onQuickAdd:l})=>{const[x,p]=n.useState([]),[c,R]=n.useState([]),[i,W]=n.useState(null),[b,Y]=n.useState(null),[z,k]=n.useState(!0),[J,S]=n.useState(!1),[K,D]=n.useState(null),[v,h]=n.useState(!1),[T,m]=n.useState(null),G=t=>{D(t),S(!0)},Q=()=>{S(!1),D(null)},g=n.useCallback(async()=>{k(!0);try{const[t,r,s]=await Promise.all([le(),ie({date:j()}),ce()]);p(t),R(r),Y(s);const{data:a,error:d}=await C.from("dashboard_metrics_v").select("*").single();!d&&a&&W(a)}catch(t){console.error(t)}k(!1)},[]);n.useEffect(()=>{g();const t=()=>{g()};return window.addEventListener("lldv2:action-items-changed",t),()=>{window.removeEventListener("lldv2:action-items-changed",t)}},[g]);const X=async()=>{if(window.confirm("Carry forward ALL overdue items to today?")){h(!0),m(null);try{const r=j(),{data:s,error:a}=await C.rpc("carry_forward_action_items",{target_date:r});if(a)throw a;const d=Number(s||0);m(`Carry forward complete: ${d} item${d===1?"":"s"} updated`),await g()}catch(r){m((r==null?void 0:r.message)||"Carry forward failed")}finally{h(!1),window.setTimeout(()=>m(null),4e3)}}},Z=async t=>{if(v)return;const r=j();if(window.confirm("Carry forward overdue items for this project to today?")){h(!0),m(null);try{const{data:a,error:d}=await C.rpc("carry_forward_action_items_by_project",{target_date:r,project_uuid:t});if(d)throw d;const u=Number(a||0);m(`Project carry forward complete: ${u} item${u===1?"":"s"} updated`),await g()}catch(a){m((a==null?void 0:a.message)||"Project carry forward failed")}finally{h(!1),window.setTimeout(()=>m(null),4e3)}}},N=n.useMemo(()=>b?[...b.activities,...b.materials,...b.equipment,...b.crew].filter(r=>{if(!r.defer_until)return!0;const s=new Date().toISOString().slice(0,10);return r.defer_until<=s}).map(r=>{var I,L,P,O,$,A,B,E;const s=r.due_date??r.required_date??null,a=r.bucket||Ce(s),d=((L=(I=r.daily_logs)==null?void 0:I.projects)==null?void 0:L.name)||((P=r.project)==null?void 0:P.name)||((O=r.projects)==null?void 0:O.name)||r._project||"Unknown",u=((A=($=r.daily_logs)==null?void 0:$.projects)==null?void 0:A.job_number)||((B=r.project)==null?void 0:B.job_number)||((E=r.projects)==null?void 0:E.job_number)||r._jobNumber||"",f=r.title||r.description||r.equipment_name||r.worker_name||"Unnamed",y=r.details||r.notes||r.note||"",_=r.priority||r._priority||"medium";return{...r,_bucket:a,_due:s,_project:d,_jobNumber:u,_title:f,_details:y,_priority:_}}):[],[b]),ee=n.useMemo(()=>{const t={overdue:[],due_today:[],upcoming:[],no_due_date:[]};for(const s of N)t[s._bucket].push(s);const r=(s,a)=>{const d=H(s._priority),u=H(a._priority);if(d!==u)return d-u;const f=s._due?new Date(s._due).getTime():Number.POSITIVE_INFINITY,y=a._due?new Date(a._due).getTime():Number.POSITIVE_INFINITY;return f-y};return Object.keys(t).forEach(s=>{t[s]=t[s].sort(r)}),t},[N]),te=x.filter(t=>t.status==="active").length,re=(i==null?void 0:i.open_total)??0,se=(i==null?void 0:i.overdue_total)??0,oe=(i==null?void 0:i.deferred_total)??0,ae=(i==null?void 0:i.completed_last_7_days)??0,de=[{label:"Active Projects",value:te,icon:pe,color:"from-blue-500 to-blue-600",textColor:"text-blue-400"},{label:"Open Items",value:re,icon:be,color:"from-indigo-500 to-indigo-600",textColor:"text-indigo-400"},{label:"Overdue",value:se,icon:M,color:"from-red-500 to-red-600",textColor:"text-danger"},{label:"Deferred",value:oe,icon:M,color:"from-purple-500 to-purple-600",textColor:"text-purple-400"},{label:"Done (7d)",value:ae,icon:U,color:"from-emerald-500 to-emerald-600",textColor:"text-emerald-400"}],ne=[{label:"Work Activity",icon:ge,color:"bg-blue-500/20 text-blue-600 border-blue-500/30",action:()=>o("daily-logs",{tab:"activities"})},{label:"Materials",icon:he,color:"bg-purple-500/20 text-purple-600 border-purple-500/30",action:()=>o("daily-logs",{tab:"materials"})},{label:"Equipment",icon:fe,color:"bg-primary/20 text-primary border-primary/30",action:()=>o("daily-logs",{tab:"equipment"})},{label:"Crew",icon:ye,color:"bg-emerald-500/20 text-emerald-600 border-emerald-500/30",action:()=>o("daily-logs",{tab:"crew"})},{label:"Visitor",icon:je,color:"bg-indigo-500/20 text-indigo-600 border-indigo-500/30",action:()=>o("daily-logs",{tab:"visitors"})},{label:"Delivery",icon:ve,color:"bg-rose-500/20 text-rose-600 border-rose-500/30",action:()=>o("calendar",{type:"delivery"})}];if(z)return e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-primary"})});const w=N.length;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Command Center"}),e.jsxs("p",{className:"text-muted-foreground text-sm mt-1",children:[F(j())," — ",c.length," job",c.length!==1?"s":""," logged today"]})]}),e.jsxs("button",{onClick:l,className:"flex items-center gap-2 px-4 py-2.5 rounded-lg bg-primary hover:bg-primary/90 text-primary-foreground font-semibold text-sm transition-colors",children:[e.jsx(xe,{className:"w-4 h-4"}),"New Job"]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3",children:de.map((t,r)=>{const s=t.icon;return e.jsxs("div",{className:"bg-card border border-primary/40 rounded-xl shadow-md hover:shadow-lg transition-all duration-150 shadow-md hover:shadow-lg transition-all duration-150 p-4 hover:border-primary/40/50 transition-colors",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("div",{className:`w-8 h-8 rounded-lg bg-gradient-to-br ${t.color} flex items-center justify-center`,children:e.jsx(s,{className:"w-4 h-4 text-foreground"})})}),e.jsx("div",{className:"text-2xl font-bold text-foreground",children:t.value}),e.jsx("div",{className:"text-xs text-muted-foreground mt-0.5",children:t.label})]},r)})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-sm font-semibold text-foreground uppercase tracking-wider mb-3",children:"Quick Add"}),e.jsx("div",{className:"grid grid-cols-3 md:grid-cols-6 gap-2",children:ne.map((t,r)=>{const s=t.icon;return e.jsxs("button",{onClick:t.action,className:`flex flex-col items-center gap-2 p-3 rounded-xl shadow-md hover:shadow-lg transition-all duration-150 shadow-md hover:shadow-lg transition-all duration-150 border ${t.color} hover:scale-105 transition-transform`,children:[e.jsx(s,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs font-medium",children:t.label})]},r)})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-sm font-semibold text-foreground uppercase tracking-wider",children:"Active Projects"}),e.jsxs("button",{onClick:()=>o("daily-logs"),className:"text-xs text-primary hover:text-primary/90 flex items-center gap-1",children:["View All ",e.jsx(Ne,{className:"w-3 h-3"})]})]}),e.jsx("div",{className:"space-y-2 max-h-[500px] overflow-y-auto pr-1",children:x.filter(t=>t.status==="active").length===0?e.jsxs("div",{className:"bg-card border border-primary/40 rounded-xl shadow-md hover:shadow-lg transition-all duration-150 shadow-md hover:shadow-lg transition-all duration-150 p-6 text-center",children:[e.jsx(we,{className:"w-8 h-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No active projects"}),e.jsx("button",{onClick:l,className:"mt-2 text-xs text-primary hover:text-primary/90",children:"Create your first job"})]}):x.filter(t=>t.status==="active").map(t=>{const r=c.filter(s=>s.project_id===t.id);return e.jsx("button",{onClick:()=>o("daily-logs",{project_id:t.id}),className:"w-full text-left bg-card border border-primary/40 rounded-xl shadow-md hover:shadow-lg transition-all duration-150 shadow-md hover:shadow-lg transition-all duration-150 p-4 hover:border-primary/30 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"text-xs font-mono text-primary bg-primary/10 px-1.5 py-0.5 rounded",children:t.job_number||"#"})}),e.jsx("h3",{className:"text-sm font-semibold text-foreground mt-1 truncate",children:t.name}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:t.location||t.client||"No location"})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1 ml-2",children:[e.jsx("button",{type:"button",onClick:s=>{s.stopPropagation(),Z(t.id)},className:"mt-1 text-[10px] px-2 py-1 rounded border border-primary/40 bg-muted hover:bg-muted/70",title:"Carry forward overdue items for this project to today",children:"Carry"}),r.length>0&&e.jsx("span",{className:"text-[10px] bg-emerald-500/10 text-emerald-400 px-1.5 py-0.5 rounded-full border border-emerald-500/20",children:"Logged today"})]})]})},t.id)})})]}),e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-sm font-semibold text-foreground uppercase tracking-wider",children:"Command Center"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>void X(),disabled:v,className:"text-xs px-2.5 py-1.5 rounded-lg border border-primary/40 bg-muted hover:bg-muted/70 text-foreground disabled:opacity-50 disabled:cursor-not-allowed",title:"Carry forward overdue items to today",children:v?"Carrying…":"Carry Forward to Today"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[w," open item",w!==1?"s":""]})]})]}),T&&e.jsx("div",{className:"mb-2 text-xs text-muted-foreground",children:T}),w===0?e.jsxs("div",{className:"bg-card border border-primary/40 rounded-xl shadow-md hover:shadow-lg transition-all duration-150 shadow-md hover:shadow-lg transition-all duration-150 p-8 text-center",children:[e.jsx(U,{className:"w-10 h-10 text-success mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-foreground font-medium",children:"All clear!"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"No outstanding items to show"})]}):e.jsx("div",{className:"space-y-4 max-h-[500px] overflow-y-auto pr-1",children:_e.map(t=>{const r=ee[t.key]||[];return r.length===0?null:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-[11px] font-semibold px-2 py-1 rounded-lg ${t.pillClass}`,children:t.title}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r.length})]})}),e.jsx("div",{className:"space-y-2",children:r.slice(0,50).map((s,a)=>e.jsx("button",{type:"button",onClick:()=>G(s),className:`w-full text-left bg-card border border-primary/40 rounded-xl shadow-md hover:shadow-lg transition-all duration-150 shadow-md hover:shadow-lg transition-all duration-150 p-3 hover:border-primary/40/50 transition-colors ${t.cardLeftBorderClass}`,children:e.jsx("div",{className:"flex items-start gap-3",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-medium text-foreground truncate",children:s._title}),e.jsx(q,{priority:String(s._priority).toLowerCase(),size:"sm",showIcon:!1}),s.category&&e.jsx("span",{className:"text-[10px] text-muted-foreground bg-muted px-1.5 py-0.5 rounded",children:String(s.category)}),s.status&&e.jsx("span",{className:"text-[10px] text-muted-foreground bg-muted px-1.5 py-0.5 rounded",children:String(s.status)})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-xs text-muted-foreground",children:[e.jsx("span",{className:"truncate",children:s._project}),s._jobNumber&&e.jsxs("span",{className:"font-mono text-primary/60",children:["#",s._jobNumber]}),s._due&&e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsxs("span",{children:["Due: ",F(s._due)]}),(()=>{const d=me(s._due);if(!d)return null;const _=d.includes("overdue")?"bg-danger/20 text-danger border-danger/50":d==="Today"?"bg-primary/20 text-primary border-primary/50":d==="Tomorrow"?"bg-amber-500/20 text-amber-300 border-amber-500/50":"bg-muted text-muted-foreground border-border";return e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded border ${_}`,children:d})})()]})]}),s._details&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 truncate",children:s._details})]})})},`${s.id||"x"}-${t.key}-${a}`))})]},t.key)})})]})]}),c.length>0&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-sm font-semibold text-foreground uppercase tracking-wider mb-3",children:"Today's Jobs"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:c.map(t=>{var r,s;return e.jsxs("button",{onClick:()=>o("daily-logs",{logId:t.id}),className:"text-left bg-card border border-primary/40 rounded-xl shadow-md hover:shadow-lg transition-all duration-150 shadow-md hover:shadow-lg transition-all duration-150 p-4 hover:border-primary/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-xs font-mono text-primary bg-primary/10 px-1.5 py-0.5 rounded",children:((r=t.project)==null?void 0:r.job_number)||"#"}),e.jsx(q,{priority:t.priority,size:"sm"})]}),e.jsx("h3",{className:"text-sm font-semibold text-foreground",children:((s=t.project)==null?void 0:s.name)||"Unknown Project"}),e.jsxs("div",{className:"flex items-center gap-3 mt-2 text-xs text-muted-foreground",children:[t.weather&&e.jsx("span",{children:t.weather}),t.temperature&&e.jsx("span",{children:t.temperature})]}),t.critical_items&&e.jsx("div",{className:"mt-2 p-2 rounded-lg bg-danger/10 border border-danger/20",children:e.jsx("p",{className:"text-xs text-danger line-clamp-2",children:t.critical_items})})]},t.id)})})]}),e.jsx(ue,{open:J,item:K,onClose:Q,onChanged:async()=>{await g()}})]})};export{Ae as default};
