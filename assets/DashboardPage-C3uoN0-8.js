import{r as n,j as t}from"./vendor-Coh6w-wA.js";import{f as ne,a as de,t as g,b as ie,c as E,r as F,s as M}from"./index-CFnRQUVA.js";import{P as le}from"./PriorityBadge-BLudzW_u.js";import{A as ce}from"./ActionItemDetailModal--w9Od5Bc.js";import{P as me,t as q,B as ue,C as be,b as U,u as pe,v as xe,w as fe,W as ye,x as ge,k as je,T as he}from"./icons-BlIjFQrJ.js";import"./radix-wrHiDKbY.js";import"./tanstack-x3w5gpW7.js";import"./supabase-jRWW_51U.js";import"./router-jL34xOpu.js";const ve=[{key:"overdue",title:"Overdue",pillClass:"bg-danger/15 text-danger border border-danger/30",cardLeftBorderClass:"border-l-4 border-l-danger/70"},{key:"due_today",title:"Due Today",pillClass:"bg-primary/15 text-primary border border-primary/30",cardLeftBorderClass:"border-l-4 border-l-primary/70"},{key:"upcoming",title:"Upcoming",pillClass:"bg-muted text-foreground border border-primary/40",cardLeftBorderClass:"border-l-4 border-l-border"},{key:"no_due_date",title:"No Due Date",pillClass:"bg-muted/60 text-muted-foreground border border-primary/40",cardLeftBorderClass:"border-l-4 border-l-muted"}];function R(o){const d=o.getFullYear(),m=String(o.getMonth()+1).padStart(2,"0"),u=String(o.getDate()).padStart(2,"0");return`${d}-${m}-${u}`}function Ne(o){if(!o)return"no_due_date";const d=new Date(o);if(Number.isNaN(d.getTime()))return"no_due_date";const u=R(new Date),x=R(d);return x<u?"overdue":x===u?"due_today":"upcoming"}function V(o){if(!o)return 3;const d=String(o).toLowerCase();return d==="critical"?0:d==="high"?1:d==="medium"?2:3}const Be=({onNavigate:o,onQuickAdd:d})=>{const[m,u]=n.useState([]),[x,W]=n.useState([]),[b,Y]=n.useState(null),[J,_]=n.useState(!0),[K,C]=n.useState(!1),[Q,w]=n.useState(null),[j,f]=n.useState(!1),[k,l]=n.useState(null),z=e=>{w(e),C(!0)},G=()=>{C(!1),w(null)},p=n.useCallback(async()=>{_(!0);try{const[e,r,s]=await Promise.all([ne(),de({date:g()}),ie()]);u(e),W(r),Y(s)}catch(e){console.error(e)}_(!1)},[]);n.useEffect(()=>{p();const e=()=>{p()};return window.addEventListener("lldv2:action-items-changed",e),()=>{window.removeEventListener("lldv2:action-items-changed",e)}},[p]);const H=async()=>{if(window.confirm("Carry forward ALL overdue items to today?")){f(!0),l(null);try{const r=g(),{data:s,error:a}=await M.rpc("carry_forward_action_items",{target_date:r});if(a)throw a;const i=Number(s||0);l(`Carry forward complete: ${i} item${i===1?"":"s"} updated`),await p()}catch(r){l((r==null?void 0:r.message)||"Carry forward failed")}finally{f(!1),window.setTimeout(()=>l(null),4e3)}}},X=async e=>{if(j)return;const r=g();if(window.confirm("Carry forward overdue items for this project to today?")){f(!0),l(null);try{const{data:a,error:i}=await M.rpc("carry_forward_action_items_by_project",{target_date:r,project_uuid:e});if(i)throw i;const c=Number(a||0);l(`Project carry forward complete: ${c} item${c===1?"":"s"} updated`),await p()}catch(a){l((a==null?void 0:a.message)||"Project carry forward failed")}finally{f(!1),window.setTimeout(()=>l(null),4e3)}}},y=n.useMemo(()=>b?[...b.activities,...b.materials,...b.equipment,...b.crew].filter(r=>!r.defer_until||r.defer_until<=new Date().toISOString().slice(0,10)).map(r=>{var I,L,P,T,$,B,A,O;const s=r.due_date??r.required_date??null,a=r.bucket||Ne(s),i=((L=(I=r.daily_logs)==null?void 0:I.projects)==null?void 0:L.name)??((P=r.project)==null?void 0:P.name)??((T=r.projects)==null?void 0:T.name)??r._project??"Unknown",c=((B=($=r.daily_logs)==null?void 0:$.projects)==null?void 0:B.job_number)??((A=r.project)==null?void 0:A.job_number)??((O=r.projects)==null?void 0:O.job_number)??r._jobNumber??"",v=r.title??r.description??r.equipment_name??r.worker_name??"Unnamed",N=r.details??r.notes??r.note??"",ae=r.priority??r._priority??"medium";return{...r,_bucket:a,_due:s,_project:String(i),_jobNumber:String(c),_title:String(v),_details:String(N),_priority:String(ae)}}):[],[b]),S=n.useMemo(()=>{const e={overdue:[],due_today:[],upcoming:[],no_due_date:[]};for(const s of y)e[s._bucket].push(s);const r=(s,a)=>{const i=V(s._priority),c=V(a._priority);if(i!==c)return i-c;const v=s._due?new Date(s._due).getTime():Number.POSITIVE_INFINITY,N=a._due?new Date(a._due).getTime():Number.POSITIVE_INFINITY;return v-N};return Object.keys(e).forEach(s=>{e[s]=e[s].sort(r)}),e},[y]),D=n.useMemo(()=>m.filter(e=>e.status==="active"),[m]),h=D.length,Z=y.length,ee=S.overdue.length,te=[{label:"Active Projects",value:h,icon:ue},{label:"Open Items",value:Z,icon:be},{label:"Overdue",value:ee,icon:U},{label:"Deferred",value:0,icon:U},{label:"Done (7d)",value:0,icon:pe}],re=[{label:"Work Activity",icon:xe,action:()=>o("daily-logs",{tab:"activities"})},{label:"Materials",icon:fe,action:()=>o("daily-logs",{tab:"materials"})},{label:"Equipment",icon:ye,action:()=>o("daily-logs",{tab:"equipment"})},{label:"Crew",icon:ge,action:()=>o("daily-logs",{tab:"crew"})},{label:"Visitor",icon:je,action:()=>o("daily-logs",{tab:"visitors"})},{label:"Delivery",icon:he,action:()=>o("calendar",{type:"delivery"})}],se=n.useMemo(()=>{const e=g();return`${E(e)} (${F(e)})`},[]);if(J)return t.jsx("div",{className:"flex items-center justify-center h-96",children:t.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-primary"})});const oe=e=>{const r=e._due?`${E(e._due)} (${F(e._due)})`:"No due date";return t.jsx("button",{type:"button",onClick:()=>z(e),className:"w-full rounded-md border p-3 text-left hover:bg-muted/50",children:t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("div",{className:"truncate font-medium",children:e._title}),e._details?t.jsx("div",{className:"mt-1 line-clamp-2 text-sm text-muted-foreground",children:e._details}):null,t.jsxs("div",{className:"mt-2 text-xs text-muted-foreground",children:[e._project,e._jobNumber?` � ${e._jobNumber}`:"",e._due?` � Due ${r}`:" � No due date"]})]}),t.jsx("div",{className:"shrink-0 flex items-center gap-2",children:t.jsx(le,{priority:e._priority})})]})},e.id)};return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"rounded-lg border bg-card p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-4",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-lg font-semibold",children:"Command Center"}),t.jsxs("div",{className:"text-sm text-muted-foreground",children:["Today: ",se]}),t.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:["Projects: ",m.length," � Today logs: ",x.length," � Items: ",y.length]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{type:"button",onClick:d,className:"inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm hover:bg-muted",children:[t.jsx(me,{className:"h-4 w-4"}),"Quick Add"]}),t.jsxs("button",{type:"button",onClick:H,disabled:j,className:"inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm hover:bg-muted disabled:opacity-50",title:"Carry forward overdue items to today",children:[t.jsx(q,{className:"h-4 w-4"}),"Carry Forward"]})]})]}),k?t.jsx("div",{className:"mt-3 text-sm text-muted-foreground",children:k}):null,t.jsx("div",{className:"mt-4 grid grid-cols-2 gap-3 md:grid-cols-5",children:te.map(e=>t.jsxs("div",{className:"rounded-md border p-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(e.icon,{className:"h-4 w-4 text-muted-foreground"}),t.jsx("div",{className:"text-xs text-muted-foreground",children:e.label})]}),t.jsx("div",{className:"mt-2 text-2xl font-semibold",children:e.value})]},e.label))}),t.jsx("div",{className:"mt-4 grid grid-cols-2 gap-2 md:grid-cols-6",children:re.map(e=>t.jsxs("button",{type:"button",onClick:e.action,className:"inline-flex items-center gap-2 rounded-md border px-3 py-2 text-sm hover:bg-muted",children:[t.jsx(e.icon,{className:"h-4 w-4"}),t.jsx("span",{className:"truncate",children:e.label})]},e.label))})]}),t.jsxs("div",{className:"rounded-lg border bg-card p-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"text-sm font-semibold",children:"Active Projects"}),t.jsxs("div",{className:"text-xs text-muted-foreground",children:[h," active"]})]}),h===0?t.jsx("div",{className:"mt-3 text-sm text-muted-foreground",children:"No active projects found (projects table currently empty for this user)."}):t.jsx("div",{className:"mt-3 space-y-2",children:D.slice(0,8).map(e=>t.jsx("div",{className:"rounded-md border p-3",children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("div",{className:"truncate font-medium",children:e.name||"Unnamed Project"}),t.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:[e.job_number?`Job ${e.job_number}`:""," ",e.site_name?`� ${e.site_name}`:""]})]}),t.jsxs("button",{type:"button",onClick:()=>X(String(e.id)),disabled:j,className:"inline-flex items-center gap-2 rounded-md border px-3 py-2 text-xs hover:bg-muted disabled:opacity-50",title:"Carry forward overdue items for this project",children:[t.jsx(q,{className:"h-3 w-3"}),"Carry"]})]})},e.id))})]}),t.jsx("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-2",children:ve.map(e=>{const r=S[e.key]||[];return t.jsxs("div",{className:`rounded-lg border bg-card p-4 ${e.cardLeftBorderClass}`,children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"text-sm font-semibold",children:e.title}),t.jsx("div",{className:`text-xs px-2 py-1 rounded-full ${e.pillClass}`,children:r.length})]}),r.length===0?t.jsx("div",{className:"mt-3 text-sm text-muted-foreground",children:"No items."}):t.jsx("div",{className:"mt-3 space-y-2",children:r.slice(0,10).map(oe)})]},e.key)})}),t.jsx(ce,{open:K,item:Q,onClose:G,onChanged:async()=>{await p()}})]})};export{Be as default};
