import{r as i,j as e}from"./vendor-Coh6w-wA.js";import{s as f,t as D,c as g}from"./index-CFnRQUVA.js";import{P as S}from"./PriorityBadge-BLudzW_u.js";import{X as A,V as I,Y as U,Z as O,u as P,Q as E}from"./icons-BlIjFQrJ.js";async function L(s,t){const a=new Date().toISOString(),l={status:t,updated_at:a};t==="done"&&(l.completed_at=a),t==="cancelled"&&(l.cancelled_at=a);const{error:d}=await f.from("action_items").update(l).eq("id",s);if(d)throw d;const c=t==="done";return await f.from("calendar_notes").update({is_completed:c}).eq("action_item_id",s),!0}async function B(s,t){const a=new Date().toISOString(),l={defer_until:t,updated_at:a},{error:d}=await f.from("action_items").update(l).eq("id",s);if(d)throw d;return!0}function R(s){const t=String(s||"open").toLowerCase();return t==="open"?"open":t==="in_progress"?"in_progress":t==="blocked"?"blocked":t==="done"?"done":t==="cancelled"?"cancelled":"open"}function q(s){const t=String(s||"medium").toLowerCase();return t==="critical"?"critical":t==="high"?"high":t==="low"?"low":"medium"}function z(s,t){const a=new Date(s+"T00:00:00");return a.setDate(a.getDate()+t),a.toISOString().slice(0,10)}function T(s){return s?s.length<=12?s:`${s.slice(0,8)}…${s.slice(-4)}`:"—"}function M(s){try{const t=new Date(s);return Number.isNaN(t.getTime())?s:t.toLocaleString()}catch{return s}}function V({open:s,item:t,onClose:a,onChanged:l}){const[d,c]=i.useState(!1),[y,m]=i.useState(null),[h,N]=i.useState([]),[v,w]=i.useState(!1),[b,_]=i.useState(null),r=i.useMemo(()=>{if(!t)return null;const o=t._title||t.title||"Unnamed",n=t._details||t.details||"",u=t._due||t.due_date||null;return{id:t.id,title:o,details:n,project:t._project||"Unknown",jobNumber:t._jobNumber||"",due:u,status:R(t.status),priority:q(t._priority||t.priority),category:t.category?String(t.category):null,source:t.source?String(t.source):null,sourceRef:t.source_ref??null,completedAt:t.completed_at||null,cancelledAt:t.cancelled_at||null,deferUntil:t.defer_until||null}},[t]),[j,C]=i.useState(()=>r!=null&&r.deferUntil?r.deferUntil:D());if(i.useEffect(()=>{if(!s||!(r!=null&&r.id))return;(async()=>{w(!0),_(null);try{const{data:n,error:u}=await f.from("action_item_audit").select("id,action,action_item_id,owner_id,changed_by,changed_at,old_row,new_row").eq("action_item_id",r.id).order("changed_at",{ascending:!1}).limit(25);if(u)throw u;N(n||[])}catch(n){_((n==null?void 0:n.message)||"Audit load failed"),N([])}finally{w(!1)}})()},[s,r==null?void 0:r.id]),!s||!r)return null;const x=async o=>{c(!0),m(null);try{await L(r.id,o),await l(),a()}catch(n){m((n==null?void 0:n.message)||"Update failed")}finally{c(!1)}},k=async o=>{c(!0),m(null);try{await B(r.id,o),await l(),a()}catch(n){m((n==null?void 0:n.message)||"Defer failed")}finally{c(!1)}},p=o=>{const n=D(),u=z(n,o);C(u)};return e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("button",{type:"button","aria-label":"Close",className:"absolute inset-0 bg-black/60",onClick:()=>d?null:a()}),e.jsx("div",{className:"absolute inset-x-0 top-10 mx-auto w-[95%] max-w-2xl",children:e.jsxs("div",{className:"bg-card border border-border rounded-2xl shadow-xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-start justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("h3",{className:"text-base font-semibold text-foreground truncate",children:r.title}),e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:r.status}),e.jsx(S,{priority:r.priority,size:"sm",showIcon:!0}),r.category&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:r.category})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-xs text-muted-foreground",children:[e.jsx("span",{className:"truncate",children:r.project}),r.jobNumber&&e.jsxs("span",{className:"font-mono text-primary/70",children:["#",r.jobNumber]}),r.due&&e.jsxs("span",{children:["Due: ",g(r.due)]})]})]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("button",{type:"button",onClick:()=>d?null:a(),className:"p-2 rounded-lg hover:bg-muted transition-colors","aria-label":"Close",children:e.jsx(A,{className:"w-4 h-4 text-muted-foreground"})})})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[y&&e.jsx("div",{className:"text-xs text-danger bg-danger/10 border border-danger/20 rounded-lg px-3 py-2",children:y}),r.details?e.jsxs("div",{className:"bg-muted/40 border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-1",children:"Details"}),e.jsx("div",{className:"text-sm text-foreground whitespace-pre-wrap",children:r.details})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-1",children:"Operational"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{children:["Status: ",e.jsx("span",{className:"text-foreground",children:r.status})]}),e.jsxs("div",{children:["Priority: ",e.jsx("span",{className:"text-foreground",children:r.priority})]}),r.deferUntil&&e.jsxs("div",{children:["Defer until: ",e.jsx("span",{className:"text-foreground",children:g(r.deferUntil)})]}),r.completedAt&&e.jsxs("div",{children:["Completed: ",e.jsx("span",{className:"text-foreground",children:g(r.completedAt)})]}),r.cancelledAt&&e.jsxs("div",{children:["Cancelled: ",e.jsx("span",{className:"text-foreground",children:g(r.cancelledAt)})]})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-1",children:"Source"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{children:["Source: ",e.jsx("span",{className:"text-foreground",children:r.source||"—"})]}),e.jsxs("div",{className:"break-words",children:["Ref: ",e.jsx("span",{className:"text-foreground",children:r.sourceRef?JSON.stringify(r.sourceRef):"—"})]})]})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"History"}),v&&e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Loading…"})]}),b&&e.jsx("div",{className:"mt-2 text-xs text-danger bg-danger/10 border border-danger/20 rounded-lg px-3 py-2",children:b}),!v&&!b&&h.length===0&&e.jsx("div",{className:"mt-2 text-xs text-muted-foreground",children:"No history yet"}),!b&&h.length>0&&e.jsx("div",{className:"mt-2 space-y-2 max-h-56 overflow-y-auto pr-1",children:h.map(o=>e.jsxs("div",{className:"border border-border rounded-lg p-2 bg-muted/30",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:o.action}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:M(o.changed_at)})]}),e.jsxs("div",{className:"mt-1 text-[11px] text-muted-foreground",children:["By: ",e.jsx("span",{className:"text-foreground",children:T(o.changed_by)})]})]},o.id))})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Defer"}),r.deferUntil?e.jsx("button",{type:"button",disabled:d,onClick:()=>k(null),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60 transition-colors",title:"Clear defer",children:"Clear"}):e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Not deferred"})]}),e.jsxs("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:j,onChange:o=>C(o.target.value),className:"w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm text-foreground"}),e.jsx("button",{type:"button",disabled:d||!j,onClick:()=>k(j),className:"px-3 py-2 rounded-xl bg-primary text-primary-foreground text-sm font-semibold hover:opacity-90 transition disabled:opacity-60",children:"Apply"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",disabled:d,onClick:()=>p(1),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60",children:"+1d"}),e.jsx("button",{type:"button",disabled:d,onClick:()=>p(3),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60",children:"+3d"}),e.jsx("button",{type:"button",disabled:d,onClick:()=>p(7),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60",children:"+7d"}),e.jsx("button",{type:"button",disabled:d,onClick:()=>p(14),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60",children:"+14d"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:[e.jsxs("button",{type:"button",disabled:d,onClick:()=>x("open"),className:"flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-border bg-muted hover:bg-muted/60 text-sm",children:[e.jsx(I,{className:"w-4 h-4"})," Open"]}),e.jsxs("button",{type:"button",disabled:d,onClick:()=>x("in_progress"),className:"flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-border bg-muted hover:bg-muted/60 text-sm",children:[e.jsx(U,{className:"w-4 h-4"})," In Progress"]}),e.jsxs("button",{type:"button",disabled:d,onClick:()=>x("blocked"),className:"flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-border bg-muted hover:bg-muted/60 text-sm",children:[e.jsx(O,{className:"w-4 h-4"})," Blocked"]}),e.jsxs("button",{type:"button",disabled:d,onClick:()=>x("done"),className:"flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-border bg-muted hover:bg-muted/60 text-sm",children:[e.jsx(P,{className:"w-4 h-4"})," Done"]}),e.jsxs("button",{type:"button",disabled:d,onClick:()=>x("cancelled"),className:"flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-border bg-muted hover:bg-muted/60 text-sm col-span-2 md:col-span-4",children:[e.jsx(E,{className:"w-4 h-4"})," Cancel"]})]})]})]})})]})}export{V as A};
