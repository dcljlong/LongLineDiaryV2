import{r,j as t}from"./vendor-Coh6w-wA.js";import{s as se,f as L,K as F,L as re,M as ae}from"./index-DOjT9gM6.js";import"./radix-wrHiDKbY.js";import"./icons-DuXLjBGX.js";import"./tanstack-x3w5gpW7.js";import"./supabase-jRWW_51U.js";import"./router-jL34xOpu.js";const U="lldv2-onsitewalk-last-project",oe=["To Do","Question","Materials","Safety","Defect","Observation","Delivery"];function pe(){var A;const[m,S]=r.useState([]),[d,b]=r.useState(""),[D,C]=r.useState(""),[f,W]=r.useState("To Do"),[E,l]=r.useState("medium"),[J,p]=r.useState(""),[g,R]=r.useState([]),[h,_]=r.useState(!1),[O,c]=r.useState(null),[G,H]=r.useState(""),[P,j]=r.useState(!1),[T,v]=r.useState(""),[y,I]=r.useState(!1),[M,u]=r.useState(null),i=r.useRef(null),N=r.useRef(null),K=r.useMemo(()=>{const e=new Map;for(const s of m)e.set(s.id,s);return e},[m]);r.useEffect(()=>{Q();const e=new Date;e.setDate(e.getDate()+1),p(e.toISOString().slice(0,10)),setTimeout(()=>{var s;return(s=i.current)==null?void 0:s.focus()},0)},[]);const k=e=>{try{localStorage.setItem(U,e)}catch{}},w=async e=>{const s=await F({project_id:e||void 0,limit:10});R(s)},Q=async()=>{var B,q;c(null);const e=await se.auth.getUser(),s=(B=e==null?void 0:e.data)==null?void 0:B.user;H((s==null?void 0:s.id)??"");const o=await L();S(o);const n=(typeof window<"u"?localStorage.getItem(U):null)||"",x=n&&o.some(te=>te.id===n)?n:((q=o[0])==null?void 0:q.id)??"";b(x);const ee=await F({project_id:x||void 0,limit:10});R(ee)},Y=e=>{if(e==="Safety"&&l("critical"),e==="Defect"&&l("high"),e==="Delivery"&&l("medium"),e==="Materials"&&l("medium"),e==="Materials"){const s=new Date;s.setDate(s.getDate()+2),p(s.toISOString().slice(0,10))}if(e==="Safety"){const s=new Date;s.setDate(s.getDate()+0),p(s.toISOString().slice(0,10))}},$=async e=>{var s;b(e),k(e),await w(e),(s=i.current)==null||s.focus()},z=async e=>{var o,n;e.preventDefault(),c(null);const s=D.trim();if(!s){c("Description is required."),(o=i.current)==null||o.focus();return}if(!d){c("Project is required.");return}if(!G){c("Not signed in. Refresh and sign in again.");return}if(!h){_(!0);try{await re({project_id:d,title:s,details:null,category:f,priority:E,status:"open",due_date:J||null,source:"onsite_walk",source_ref:{type:f}});try{window.dispatchEvent(new CustomEvent("lldv2:action-items-changed",{detail:{project_id:d}}))}catch{}C(""),await w(d),(n=i.current)==null||n.focus()}catch(a){c((a==null?void 0:a.message)||"Failed to save entry.")}finally{_(!1)}}},V=()=>{u(null),j(!0),setTimeout(()=>{var e;return(e=N.current)==null?void 0:e.focus()},0)},X=()=>{u(null),v(""),j(!1),setTimeout(()=>{var e;return(e=i.current)==null?void 0:e.focus()},0)},Z=async e=>{var o,n;e.preventDefault(),u(null);const s=T.trim();if(!s){u("Job name is required."),(o=N.current)==null||o.focus();return}if(!y){I(!0);try{const a=await ae({name:s,status:"active"}),x=await L();S(x),b(a.id),k(a.id),v(""),j(!1),await w(a.id);try{window.dispatchEvent(new CustomEvent("lldv2:projects-changed",{detail:{project_id:a.id}}))}catch{}(n=i.current)==null||n.focus()}catch(a){u((a==null?void 0:a.message)||"Failed to create job.")}finally{I(!1)}}};return t.jsxs("div",{className:"p-4 lg:p-6 space-y-6 max-w-3xl",children:[t.jsxs("div",{className:"bg-card border border-border rounded-2xl p-5 space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsx("h1",{className:"text-lg font-semibold text-foreground",children:"Onsite Walk"}),t.jsx("div",{className:"flex items-center gap-2",children:!P&&t.jsx("button",{type:"button",onClick:V,className:"text-xs px-2.5 py-1.5 rounded-lg border border-border bg-muted hover:bg-muted/70 text-foreground",title:"Create a new job",children:"New Job"})})]}),P&&t.jsxs("form",{onSubmit:Z,className:"border border-border rounded-xl p-3 space-y-2 bg-muted/30",children:[t.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Create Job"}),t.jsx("input",{ref:N,value:T,onChange:e=>v(e.target.value),placeholder:"Job name…",className:"w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm"}),M&&t.jsx("div",{className:"text-xs text-red-500",children:M}),t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsx("button",{type:"button",onClick:X,className:"text-xs px-2.5 py-1.5 rounded-lg border border-border bg-transparent hover:bg-muted/40 text-foreground",children:"Cancel"}),t.jsx("button",{type:"submit",disabled:y,className:"text-xs px-3 py-1.5 rounded-lg bg-primary text-primary-foreground font-semibold disabled:opacity-50",children:y?"Creating…":"Create"})]})]}),t.jsxs("form",{onSubmit:z,className:"space-y-3",children:[t.jsxs("select",{value:d,onChange:e=>void $(e.target.value),className:"w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm",children:[m.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id)),m.length===0&&t.jsx("option",{value:"",children:"No projects"})]}),t.jsx("input",{ref:i,value:D,onChange:e=>C(e.target.value),placeholder:"One-line entry (press Enter to save)…",className:"w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm"}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsx("select",{value:f,onChange:e=>{const s=e.target.value;W(s),Y(s)},className:"bg-transparent border border-border rounded-lg px-3 py-2 text-sm",children:oe.map(e=>t.jsx("option",{value:e,children:e},e))}),t.jsxs("select",{value:E,onChange:e=>l(e.target.value),className:"bg-transparent border border-border rounded-lg px-3 py-2 text-sm",children:[t.jsx("option",{value:"critical",children:"Critical"}),t.jsx("option",{value:"high",children:"High"}),t.jsx("option",{value:"medium",children:"Medium"}),t.jsx("option",{value:"low",children:"Low"})]})]}),t.jsx("input",{type:"date",value:J,onChange:e=>p(e.target.value),className:"w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm"}),O&&t.jsx("div",{className:"text-xs text-red-500",children:O}),t.jsx("button",{type:"submit",disabled:h,className:"w-full bg-primary text-primary-foreground rounded-lg py-2 text-sm font-semibold",children:h?"Saving...":"Add Entry"}),t.jsxs("div",{className:"text-xs text-muted-foreground",children:["Current project: ",t.jsx("span",{className:"text-foreground",children:((A=K.get(d))==null?void 0:A.name)??"—"})]})]})]}),t.jsxs("div",{className:"bg-card border border-border rounded-2xl p-5",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h2",{className:"text-sm font-semibold text-foreground",children:"Recent Entries"}),t.jsxs("div",{className:"text-xs text-muted-foreground",children:["Showing last ",Math.min(g.length,10)]})]}),t.jsxs("div",{className:"space-y-2 text-sm",children:[g.map(e=>t.jsxs("div",{className:"border border-border rounded-lg p-2",children:[t.jsx("div",{className:"font-medium",children:e.title}),t.jsxs("div",{className:"text-xs text-muted-foreground",children:[e.category," • ",e.priority," • ",e.status,e.due_date?` • Due ${e.due_date}`:""]})]},e.id)),g.length===0&&t.jsx("div",{className:"text-xs text-muted-foreground",children:"No entries yet."})]})]})]})}export{pe as default};
