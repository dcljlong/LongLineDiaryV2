import{r as b,j as e}from"./vendor-Ctk_PxZ3.js";import{I as N,t as y,c as p}from"./index-wlBa9spr.js";import{X as v,_ as w,$ as C,a0 as _,y as k,Z as D}from"./icons-Uc_ZW2XO.js";async function S(n,r){const d=new Date().toISOString(),l={status:r,updated_at:d};r==="done"&&(l.completed_at=d),r==="cancelled"&&(l.cancelled_at=d);const{error:s}=await N.from("action_items").update(l).eq("id",n);if(s)throw s;return!0}async function A(n,r){const d=new Date().toISOString(),l={defer_until:r,updated_at:d},{error:s}=await N.from("action_items").update(l).eq("id",n);if(s)throw s;return!0}function U(n){const r=String(n||"open").toLowerCase();return r==="open"?"open":r==="in_progress"?"in_progress":r==="blocked"?"blocked":r==="done"?"done":r==="cancelled"?"cancelled":"open"}function I(n){const r=String(n||"medium").toLowerCase();return r==="high"?"high":r==="low"?"low":"medium"}function O(n,r){const d=new Date(n+"T00:00:00");return d.setDate(d.getDate()+r),d.toISOString().slice(0,10)}function B({open:n,item:r,onClose:d,onChanged:l}){const[s,i]=b.useState(!1),[g,u]=b.useState(null),t=b.useMemo(()=>{if(!r)return null;const a=r._title||r.title||"Unnamed",o=r._details||r.details||"",f=r._due||r.due_date||null;return{id:r.id,title:a,details:o,project:r._project||"Unknown",jobNumber:r._jobNumber||"",due:f,status:U(r.status),priority:I(r._priority||r.priority),pinned:(r._pinned??r.pinned)===!0,category:r.category?String(r.category):null,source:r.source?String(r.source):null,sourceRef:r.source_ref??null,completedAt:r.completed_at||null,cancelledAt:r.cancelled_at||null,deferUntil:r.defer_until||null}},[r]),[m,h]=b.useState(()=>t!=null&&t.deferUntil?t.deferUntil:y());if(!n||!t)return null;const c=async a=>{i(!0),u(null);try{await S(t.id,a),await l(),d()}catch(o){u((o==null?void 0:o.message)||"Update failed")}finally{i(!1)}},j=async a=>{i(!0),u(null);try{await A(t.id,a),await l(),d()}catch(o){u((o==null?void 0:o.message)||"Defer failed")}finally{i(!1)}},x=a=>{const o=y(),f=O(o,a);h(f)};return e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("button",{type:"button","aria-label":"Close",className:"absolute inset-0 bg-black/60",onClick:()=>s?null:d()}),e.jsx("div",{className:"absolute inset-x-0 top-10 mx-auto w-[95%] max-w-2xl",children:e.jsxs("div",{className:"bg-card border border-border rounded-2xl shadow-xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-start justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("h3",{className:"text-base font-semibold text-foreground truncate",children:t.title}),e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:t.status}),e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:t.priority}),t.category&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:t.category})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-xs text-muted-foreground",children:[e.jsx("span",{className:"truncate",children:t.project}),t.jobNumber&&e.jsxs("span",{className:"font-mono text-primary/70",children:["#",t.jobNumber]}),t.due&&e.jsxs("span",{children:["Due: ",p(t.due)]})]})]}),e.jsx("button",{type:"button",onClick:()=>s?null:d(),className:"p-2 rounded-lg hover:bg-muted transition-colors","aria-label":"Close",children:e.jsx(v,{className:"w-4 h-4 text-muted-foreground"})})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[t.details?e.jsxs("div",{className:"bg-muted/40 border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-1",children:"Details"}),e.jsx("div",{className:"text-sm text-foreground whitespace-pre-wrap",children:t.details})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-1",children:"Operational"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{children:["Status: ",e.jsx("span",{className:"text-foreground",children:t.status})]}),e.jsxs("div",{children:["Priority: ",e.jsx("span",{className:"text-foreground",children:t.priority})]}),e.jsxs("div",{children:["Pinned: ",e.jsx("span",{className:"text-foreground",children:t.pinned?"yes":"no"})]}),t.deferUntil&&e.jsxs("div",{children:["Defer until: ",e.jsx("span",{className:"text-foreground",children:p(t.deferUntil)})]}),t.completedAt&&e.jsxs("div",{children:["Completed: ",e.jsx("span",{className:"text-foreground",children:p(t.completedAt)})]}),t.cancelledAt&&e.jsxs("div",{children:["Cancelled: ",e.jsx("span",{className:"text-foreground",children:p(t.cancelledAt)})]})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-1",children:"Source"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{children:["Source: ",e.jsx("span",{className:"text-foreground",children:t.source||"—"})]}),e.jsxs("div",{className:"break-words",children:["Ref: ",e.jsx("span",{className:"text-foreground",children:t.sourceRef?JSON.stringify(t.sourceRef):"—"})]})]})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Defer"}),t.deferUntil?e.jsx("button",{type:"button",disabled:s,onClick:()=>j(null),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60 transition-colors",title:"Clear defer",children:"Clear"}):e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Not deferred"})]}),e.jsxs("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:m,onChange:a=>h(a.target.value),className:"w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm text-foreground"}),e.jsx("button",{type:"button",disabled:s||!m,onClick:()=>j(m),className:"px-3 py-2 rounded-xl bg-primary text-primary-foreground text-sm font-semibold hover:opacity-90 transition disabled:opacity-60",children:"Apply"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",disabled:s,onClick:()=>x(1),className:"px-2.5 py-2 rounded-xl border border-border bg-card hover:bg-muted transition-colors text-xs",children:"+1d"}),e.jsx("button",{type:"button",disabled:s,onClick:()=>x(3),className:"px-2.5 py-2 rounded-xl border border-border bg-card hover:bg-muted transition-colors text-xs",children:"+3d"}),e.jsx("button",{type:"button",disabled:s,onClick:()=>x(7),className:"px-2.5 py-2 rounded-xl border border-border bg-card hover:bg-muted transition-colors text-xs",children:"+7d"}),e.jsx("button",{type:"button",disabled:s,onClick:()=>x(14),className:"px-2.5 py-2 rounded-xl border border-border bg-card hover:bg-muted transition-colors text-xs",children:"+14d"})]})]}),e.jsx("div",{className:"mt-2 text-[11px] text-muted-foreground",children:"Deferred items stay hidden until the defer date (we’ll apply the filter in the dashboard fetch next)."})]}),g&&e.jsx("div",{className:"bg-danger/10 border border-danger/20 text-danger rounded-xl p-3 text-sm",children:g})]}),e.jsx("div",{className:"p-4 border-t border-border",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-2",children:[e.jsxs("button",{type:"button",disabled:s,onClick:()=>c("open"),className:"px-3 py-2 rounded-xl border border-border bg-card hover:bg-muted transition-colors text-sm flex items-center justify-center gap-2",children:[e.jsx(w,{className:"w-4 h-4"})," Open"]}),e.jsxs("button",{type:"button",disabled:s,onClick:()=>c("in_progress"),className:"px-3 py-2 rounded-xl border border-border bg-card hover:bg-muted transition-colors text-sm flex items-center justify-center gap-2",children:[e.jsx(C,{className:"w-4 h-4"})," In Prog"]}),e.jsxs("button",{type:"button",disabled:s,onClick:()=>c("blocked"),className:"px-3 py-2 rounded-xl border border-border bg-card hover:bg-muted transition-colors text-sm flex items-center justify-center gap-2",children:[e.jsx(_,{className:"w-4 h-4"})," Blocked"]}),e.jsxs("button",{type:"button",disabled:s,onClick:()=>c("done"),className:"px-3 py-2 rounded-xl border border-success/30 bg-success/10 hover:bg-success/15 transition-colors text-sm flex items-center justify-center gap-2 text-success",children:[e.jsx(k,{className:"w-4 h-4"})," Complete"]}),e.jsxs("button",{type:"button",disabled:s,onClick:()=>c("cancelled"),className:"px-3 py-2 rounded-xl border border-danger/30 bg-danger/10 hover:bg-danger/15 transition-colors text-sm flex items-center justify-center gap-2 text-danger",children:[e.jsx(D,{className:"w-4 h-4"})," Cancel"]})]})})]})})]})}export{B as A};
