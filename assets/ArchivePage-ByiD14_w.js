import{r as i,j as e}from"./vendor-CXHg10W4.js";import{z as w,t as D,F as p}from"./index-DH1J7dfm.js";import{P as U}from"./PriorityBadge-DDRw9Q8x.js";import{X as I,y as O,O as L,z as $,i as k,G as A,R,S as q}from"./icons-B9Y_x3Mi.js";import"./radix-Ot_dPVsw.js";import"./tanstack-DPykmZse.js";import"./router-BXPJCNNf.js";import"./supabase-B741jp4W.js";async function P(d,r){const c=new Date().toISOString(),u={status:r,updated_at:c};r==="done"&&(u.completed_at=c),r==="cancelled"&&(u.cancelled_at=c);const{error:a}=await w.from("action_items").update(u).eq("id",d);if(a)throw a;const x=r==="done";return await w.from("calendar_notes").update({is_completed:x}).eq("action_item_id",d),!0}async function E(d,r){const c=new Date().toISOString(),u={defer_until:r,updated_at:c},{error:a}=await w.from("action_items").update(u).eq("id",d);if(a)throw a;return!0}function z(d){const r=String(d||"open").toLowerCase();return r==="open"?"open":r==="in_progress"?"in_progress":r==="blocked"?"blocked":r==="done"?"done":r==="cancelled"?"cancelled":"open"}function F(d){const r=String(d||"medium").toLowerCase();return r==="critical"?"critical":r==="high"?"high":r==="low"?"low":"medium"}function T(d,r){const c=new Date(d+"T00:00:00");return c.setDate(c.getDate()+r),c.toISOString().slice(0,10)}function B(d){return d?d.length<=12?d:`${d.slice(0,8)}…${d.slice(-4)}`:"—"}function M(d){try{const r=new Date(d);return Number.isNaN(r.getTime())?d:r.toLocaleString()}catch{return d}}function Q({open:d,item:r,onClose:c,onChanged:u}){const[a,x]=i.useState(!1),[g,f]=i.useState(null),[h,_]=i.useState([]),[C,y]=i.useState(!1),[j,v]=i.useState(null),s=i.useMemo(()=>{if(!r)return null;const n=r._title||r.title||"Unnamed",l=r._details||r.details||"",N=r._due||r.due_date||null;return{id:r.id,title:n,details:l,project:r._project||"Unknown",jobNumber:r._jobNumber||"",due:N,status:z(r.status),priority:F(r._priority||r.priority),category:r.category?String(r.category):null,source:r.source?String(r.source):null,sourceRef:r.source_ref??null,completedAt:r.completed_at||null,cancelledAt:r.cancelled_at||null,deferUntil:r.defer_until||null}},[r]),[m,S]=i.useState(()=>s!=null&&s.deferUntil?s.deferUntil:D());if(i.useEffect(()=>{if(!d||!(s!=null&&s.id))return;(async()=>{y(!0),v(null);try{const{data:l,error:N}=await w.from("action_item_audit").select("id,action,action_item_id,owner_id,changed_by,changed_at,old_row,new_row").eq("action_item_id",s.id).order("changed_at",{ascending:!1}).limit(25);if(N)throw N;_(l||[])}catch(l){v((l==null?void 0:l.message)||"Audit load failed"),_([])}finally{y(!1)}})()},[d,s==null?void 0:s.id]),!d||!s)return null;const b=async n=>{x(!0),f(null);try{await P(s.id,n),await u(),c()}catch(l){f((l==null?void 0:l.message)||"Update failed")}finally{x(!1)}},t=async n=>{x(!0),f(null);try{await E(s.id,n),await u(),c()}catch(l){f((l==null?void 0:l.message)||"Defer failed")}finally{x(!1)}},o=n=>{const l=D(),N=T(l,n);S(N)};return e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("button",{type:"button","aria-label":"Close",className:"absolute inset-0 bg-black/60",onClick:()=>a?null:c()}),e.jsx("div",{className:"absolute inset-x-0 top-10 mx-auto w-[95%] max-w-2xl",children:e.jsxs("div",{className:"bg-card border border-border rounded-2xl shadow-xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-start justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("h3",{className:"text-base font-semibold text-foreground truncate",children:s.title}),e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:s.status}),e.jsx(U,{priority:s.priority,size:"sm",showIcon:!0}),s.category&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:s.category})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-xs text-muted-foreground",children:[e.jsx("span",{className:"truncate",children:s.project}),s.jobNumber&&e.jsxs("span",{className:"font-mono text-primary/70",children:["#",s.jobNumber]}),s.due&&e.jsxs("span",{children:["Due: ",p(s.due)]})]})]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("button",{type:"button",onClick:()=>a?null:c(),className:"p-2 rounded-lg hover:bg-muted transition-colors","aria-label":"Close",children:e.jsx(I,{className:"w-4 h-4 text-muted-foreground"})})})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[g&&e.jsx("div",{className:"text-xs text-danger bg-danger/10 border border-danger/20 rounded-lg px-3 py-2",children:g}),s.details?e.jsxs("div",{className:"bg-muted/40 border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-1",children:"Details"}),e.jsx("div",{className:"text-sm text-foreground whitespace-pre-wrap",children:s.details})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-1",children:"Operational"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{children:["Status: ",e.jsx("span",{className:"text-foreground",children:s.status})]}),e.jsxs("div",{children:["Priority: ",e.jsx("span",{className:"text-foreground",children:s.priority})]}),s.deferUntil&&e.jsxs("div",{children:["Defer until: ",e.jsx("span",{className:"text-foreground",children:p(s.deferUntil)})]}),s.completedAt&&e.jsxs("div",{children:["Completed: ",e.jsx("span",{className:"text-foreground",children:p(s.completedAt)})]}),s.cancelledAt&&e.jsxs("div",{children:["Cancelled: ",e.jsx("span",{className:"text-foreground",children:p(s.cancelledAt)})]})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-1",children:"Source"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{children:["Source: ",e.jsx("span",{className:"text-foreground",children:s.source||"—"})]}),e.jsxs("div",{className:"break-words",children:["Ref: ",e.jsx("span",{className:"text-foreground",children:s.sourceRef?JSON.stringify(s.sourceRef):"—"})]})]})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"History"}),C&&e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Loading…"})]}),j&&e.jsx("div",{className:"mt-2 text-xs text-danger bg-danger/10 border border-danger/20 rounded-lg px-3 py-2",children:j}),!C&&!j&&h.length===0&&e.jsx("div",{className:"mt-2 text-xs text-muted-foreground",children:"No history yet"}),!j&&h.length>0&&e.jsx("div",{className:"mt-2 space-y-2 max-h-56 overflow-y-auto pr-1",children:h.map(n=>e.jsxs("div",{className:"border border-border rounded-lg p-2 bg-muted/30",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:n.action}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:M(n.changed_at)})]}),e.jsxs("div",{className:"mt-1 text-[11px] text-muted-foreground",children:["By: ",e.jsx("span",{className:"text-foreground",children:B(n.changed_by)})]})]},n.id))})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Defer"}),s.deferUntil?e.jsx("button",{type:"button",disabled:a,onClick:()=>t(null),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60 transition-colors",title:"Clear defer",children:"Clear"}):e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Not deferred"})]}),e.jsxs("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:m,onChange:n=>S(n.target.value),className:"w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm text-foreground"}),e.jsx("button",{type:"button",disabled:a||!m,onClick:()=>t(m),className:"px-3 py-2 rounded-xl bg-primary text-primary-foreground text-sm font-semibold hover:opacity-90 transition disabled:opacity-60",children:"Apply"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",disabled:a,onClick:()=>o(1),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60",children:"+1d"}),e.jsx("button",{type:"button",disabled:a,onClick:()=>o(3),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60",children:"+3d"}),e.jsx("button",{type:"button",disabled:a,onClick:()=>o(7),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60",children:"+7d"}),e.jsx("button",{type:"button",disabled:a,onClick:()=>o(14),className:"text-xs px-2 py-1 rounded-lg border border-border bg-muted hover:bg-muted/60",children:"+14d"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:[e.jsxs("button",{type:"button",disabled:a,onClick:()=>b("open"),className:"flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-border bg-muted hover:bg-muted/60 text-sm",children:[e.jsx(O,{className:"w-4 h-4"})," Open"]}),e.jsxs("button",{type:"button",disabled:a,onClick:()=>b("in_progress"),className:"flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-border bg-muted hover:bg-muted/60 text-sm",children:[e.jsx(L,{className:"w-4 h-4"})," In Progress"]}),e.jsxs("button",{type:"button",disabled:a,onClick:()=>b("blocked"),className:"flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-border bg-muted hover:bg-muted/60 text-sm",children:[e.jsx($,{className:"w-4 h-4"})," Blocked"]}),e.jsxs("button",{type:"button",disabled:a,onClick:()=>b("done"),className:"flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-border bg-muted hover:bg-muted/60 text-sm",children:[e.jsx(k,{className:"w-4 h-4"})," Done"]}),e.jsxs("button",{type:"button",disabled:a,onClick:()=>b("cancelled"),className:"flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-border bg-muted hover:bg-muted/60 text-sm col-span-2 md:col-span-4",children:[e.jsx(A,{className:"w-4 h-4"})," Cancel"]})]})]})]})})]})}const Z=()=>{const[d,r]=i.useState([]),[c,u]=i.useState(!0),[a,x]=i.useState("all"),[g,f]=i.useState(""),[h,_]=i.useState(()=>{const t=new Date;t.setDate(t.getDate()-30);const o=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0");return`${o}-${n}-${l}`}),[C,y]=i.useState(!1),[j,v]=i.useState(null),s=async()=>{u(!0);try{let t=w.from("action_items").select("*").in("status",["done","cancelled"]).is("deleted_at",null).gte("updated_at",new Date(h).toISOString()).order("updated_at",{ascending:!1}).limit(500);const{data:o,error:n}=await t;if(n)throw n;r(o||[])}catch(t){console.error(t),r([])}finally{u(!1)}};i.useEffect(()=>{s()},[]);const m=i.useMemo(()=>{const t=g.trim().toLowerCase();return d.filter(o=>a==="all"?!0:o.status===a).filter(o=>t?`${o.title||""} ${o.details||""} ${o.site_name||""}`.toLowerCase().includes(t):!0)},[d,a,g]),S=t=>{v({...t,_title:t.title||"Unnamed",_details:t.details||"",_project:t.site_name||"—",_jobNumber:"",_due:t.due_date,_pinned:t.pinned===!0,_priority:t.priority||"medium"}),y(!0)},b=()=>{y(!1),v(null)};return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Archive"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Completed and cancelled items retained for reporting."})]}),e.jsxs("button",{onClick:s,className:"flex items-center gap-2 px-3 py-2 rounded-xl bg-card border border-border hover:bg-muted transition-colors text-sm",children:[e.jsx(R,{className:"w-4 h-4"}),"Refresh"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-3",children:[e.jsxs("div",{className:"lg:col-span-2 bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-2",children:"Search"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("input",{value:g,onChange:t=>f(t.target.value),placeholder:"Title / details / site...",className:"w-full bg-transparent outline-none text-sm text-foreground placeholder:text-muted-foreground"})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-2",children:"Status"}),e.jsx("div",{className:"flex gap-1",children:["all","done","cancelled"].map(t=>e.jsx("button",{onClick:()=>x(t),className:`px-2.5 py-1 rounded-lg text-xs font-medium transition-colors border ${a===t?"bg-muted text-foreground border-border":"text-muted-foreground hover:text-foreground border-transparent"}`,children:t==="all"?"All":t==="done"?"Done":"Cancelled"},t))})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground mb-2",children:"From"}),e.jsx("input",{type:"date",value:h,onChange:t=>_(t.target.value),className:"w-full bg-transparent outline-none text-sm text-foreground"}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:s,className:"w-full px-3 py-2 rounded-xl bg-primary text-primary-foreground text-sm font-semibold hover:opacity-90 transition",children:"Apply"})})]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[m.length," item",m.length!==1?"s":""]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Today: ",p(D())]})]}),c?e.jsx("div",{className:"p-6 text-sm text-muted-foreground",children:"Loading…"}):m.length===0?e.jsx("div",{className:"p-8 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-muted-foreground",children:[e.jsx(k,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm",children:"No archived items found"})]})}):e.jsx("div",{className:"max-h-[560px] overflow-y-auto",children:m.map(t=>{const o=t.status==="done",n=o?t.completed_at:t.cancelled_at;return e.jsx("button",{onClick:()=>S(t),className:"w-full text-left px-4 py-3 border-b border-border hover:bg-muted/40 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-medium text-foreground truncate",children:t.title||"Unnamed"}),e.jsx("span",{className:`text-[10px] px-2 py-0.5 rounded border ${o?"border-success/30 bg-success/10 text-success":"border-danger/30 bg-danger/10 text-danger"}`,children:o?"Done":"Cancelled"}),t.priority&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:t.priority}),t.category&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded border border-border bg-muted text-muted-foreground",children:t.category})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-xs text-muted-foreground",children:[e.jsx("span",{className:"truncate",children:t.site_name||"—"}),t.due_date&&e.jsxs("span",{children:["Due: ",p(t.due_date)]}),n&&e.jsxs("span",{children:[o?"Completed":"Cancelled",": ",p(n)]})]}),t.details&&e.jsx("div",{className:"mt-1 text-xs text-muted-foreground truncate",children:t.details})]}),e.jsx("div",{className:"pt-1",children:o?e.jsx(k,{className:"w-4 h-4 text-success"}):e.jsx(A,{className:"w-4 h-4 text-danger"})})]})},t.id)})})]}),e.jsx(Q,{open:C,item:j,onClose:b,onChanged:async()=>{await s()}})]})};export{Z as default};
